<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klant Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css">
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script type="module">
    // Firebase configuratie
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import { getFirestore, doc, getDoc, query, where, getDocs, collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    const firebaseConfig = {
        apiKey: "AIzaSyA4fqK1WbKmpCNcj-6TjB6dqbsw6R3mwnI",
        authDomain: "register-employee-gcs.firebaseapp.com",
        projectId: "register-employee-gcs",
        storageBucket: "register-employee-gcs.appspot.com",
        messagingSenderId: "823490257683",
        appId: "1:823490257683:web:aaa4aa6897ad0bbca470e6",
        measurementId: "G-Q68YZMSFJX"
    };
        
    // Firebase initialiseren
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentWeek = 0; // Huidige week-index (0 = deze week, -1 = vorige week, 1 = volgende week, etc.)

    // Functie om naar de vorige week te gaan
    function previousWeek() {
        if (currentWeek > -6) { // Limiteer tot maximaal 6 weken terug
            currentWeek--;
            const employeeId = document.getElementById('employee-select').value;
            if (employeeId) {
                loadLoggedHours(employeeId, currentWeek);
            }
        }
    }

    // Functie om naar de volgende week te gaan
    function nextWeek() {
        currentWeek++;
        const employeeId = document.getElementById('employee-select').value;
        if (employeeId) {
            loadLoggedHours(employeeId, currentWeek);
        }
    }

    // Zorg ervoor dat de functies voor vorige en volgende week beschikbaar zijn
    window.previousWeek = previousWeek;
    window.nextWeek = nextWeek;

    // Controleer of gebruiker is ingelogd
    onAuthStateChanged(auth, user => {
        if (user) {
            console.log('Gebruiker ingelogd:', user);
            // Haal gegevens op voor de ingelogde klant
            const userDocRef = doc(db, 'customers', user.uid);
            getDoc(userDocRef).then(doc => {
                if (doc.exists && doc.data().Role === 'Klant') {
                    const data = doc.data();
                    document.getElementById('customer-name').textContent = data['Customer Name'];
                    document.getElementById('customer-email').textContent = user.email;
                    loadProjects(user.uid);
                    loadEmployees(user.uid);
                    loadEmployeesForEvent(user.uid);
                    loadEmployeesForDownload(user.uid);
                    loadCalendar(user.uid);
                } else {
                    console.log('Geen gegevens gevonden voor deze gebruiker of gebruiker is geen klant.');
                    alert('Ongeldige rol. Neem contact op met de beheerder.');
                    auth.signOut().then(() => {
                        window.location.href = 'klanten_login.html';
                    });
                }
            });
        } else {
            console.log('Geen gebruiker ingelogd.');
            window.location.href = 'klanten_login.html';
        }
    });

    // Functie om projecten op te halen
    function loadProjects(customerId) {
        const q = query(collection(db, 'projects'), where('customerId', '==', customerId));
        getDocs(q).then(querySnapshot => {
            const projectList = document.getElementById('project-list');
            projectList.innerHTML = ''; // Leeg de lijst voor nieuwe items
            querySnapshot.forEach(doc => {
                const project = doc.data();
                const projectItem = document.createElement('div');
                projectItem.textContent = `Project: ${project.title}`;
                projectList.appendChild(projectItem);
            });
        });
    }

    // Functie om werknemers op te halen en keuzemenu te vullen voor geregistreerde uren
    function loadEmployees(customerId) {
        const q = query(collection(db, 'employees'), where('customerId', '==', customerId));
        getDocs(q).then(querySnapshot => {
            const employeeSelect = document.getElementById('employee-select');
            employeeSelect.innerHTML = '<option value="">Selecteer een werknemer</option>'; // Leeg de lijst voor nieuwe items
            querySnapshot.forEach(doc => {
                const employee = doc.data();
                const employeeOption = document.createElement('option');
                employeeOption.value = doc.id;
                employeeOption.textContent = `${employee.FirstName} ${employee.LastName}`;
                employeeSelect.appendChild(employeeOption);
            });

            // Event listener voor werknemer selectie
            employeeSelect.addEventListener('change', function() {
                const employeeId = employeeSelect.value;
                if (employeeId) {
                    loadLoggedHours(employeeId, currentWeek);
                } else {
                    document.getElementById('hours-logged').innerHTML = ''; // Leeg de lijst als geen werknemer is geselecteerd
                }
            });
        });
    }

    // Functie om werknemers op te halen en keuzemenu te vullen voor evenement toevoegen
    function loadEmployeesForEvent(customerId) {
        const q = query(collection(db, 'employees'), where('customerId', '==', customerId));
        getDocs(q).then(querySnapshot => {
            const employeeSelect = document.getElementById('event-employee-select');
            employeeSelect.innerHTML = '<option value="all">Alle werknemers</option>'; // Leeg de lijst voor nieuwe items
            querySnapshot.forEach(doc => {
                const employee = doc.data();
                const employeeOption = document.createElement('option');
                employeeOption.value = doc.id;
                employeeOption.textContent = `${employee.FirstName} ${employee.LastName}`;
                employeeSelect.appendChild(employeeOption);
            });
        }).catch(error => {
            console.error('Fout bij het ophalen van werknemers voor evenement:', error);
        });
    }

    // Functie om werknemers op te halen en keuzemenu te vullen voor download geregistreerde uren
    function loadEmployeesForDownload(customerId) {
        const q = query(collection(db, 'employees'), where('customerId', '==', customerId));
        getDocs(q).then(querySnapshot => {
            const employeeSelect = document.getElementById('download-employee-select');
            employeeSelect.innerHTML = '<option value="">Selecteer een werknemer</option>'; // Leeg de lijst voor nieuwe items
            querySnapshot.forEach(doc => {
                const employee = doc.data();
                const employeeOption = document.createElement('option');
                employeeOption.value = doc.id;
                employeeOption.textContent = `${employee.FirstName} ${employee.LastName}`;
                employeeSelect.appendChild(employeeOption);
            });
        }).catch(error => {
            console.error('Fout bij het ophalen van werknemers voor download:', error);
        });
    }

    // Functie om geregistreerde uren op te halen
    function loadLoggedHours(employeeId, weekOffset) {
        const weekRange = getWeekRange(weekOffset);
        const q = query(collection(db, 'hours'), where('userId', '==', employeeId), where('day', '>=', weekRange.start), where('day', '<=', weekRange.end));
        getDocs(q).then(querySnapshot => {
            const hoursLogged = document.getElementById('hours-logged');
            hoursLogged.innerHTML = ''; // Leegmaken van de huidige inhoud
            querySnapshot.forEach(doc => {
                const hours = doc.data();
                const hoursItem = document.createElement('div');
                hoursItem.className = 'hours-item';
                hoursItem.innerHTML = `
                    <span>${hours.day.toDate().toISOString().split('T')[0]}</span>
                    <span>${hours.startTime}</span>
                    <span>${hours.breakTime} min</span>
                    <span>${hours.endTime}</span>
                    <span>${hours.hoursWorked} uur</span>
                    <span class="notes-item" data-notes="${hours.notes ? hours.notes : 'Geen notitie'}">${hours.notes ? 'Notitie weergeven' : 'Geen notitie'}</span>
                `;
                hoursLogged.appendChild(hoursItem);
            });
            // Voeg event listener toe na het toevoegen van items
            document.querySelectorAll('.notes-item').forEach(item => {
                item.addEventListener('click', function() {
                    showNotePopup(this.getAttribute('data-notes'));
                });
            });
        }).catch((error) => {
            console.error('Fout bij het ophalen van de geregistreerde uren:', error);
        });
    }

    // Functie om notitie pop-up te tonen
    function showNotePopup(noteContent) {
        const popup = document.getElementById('notes-popup');
        popup.textContent = noteContent;
        popup.classList.add('visible');
    }

    // Sluit notitie pop-up wanneer er buiten wordt geklikt
    window.onclick = function(event) {
        const popup = document.getElementById('notes-popup');
        if (!event.target.matches('.notes-item') && !popup.contains(event.target)) {
            popup.classList.remove('visible');
        }
    }

    // Functie om de huidige week te berekenen
    function getWeekRange(weekOffset) {
        const now = new Date();
        const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + 1 + (weekOffset * 7))); // Start op maandag
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        return { start: startOfWeek, end: endOfWeek };
    }

    // Functie om de agenda te laden
    function loadCalendar(customerId) {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: function(fetchInfo, successCallback, failureCallback) {
                const q1 = query(collection(db, 'events'), where('customerId', '==', customerId));
                const q2 = query(collection(db, 'events'), where('assignedTo', '==', 'all'));
                const q3 = query(collection(db, 'events'), where('type', '==', 'leave'));

                Promise.all([getDocs(q1), getDocs(q2), getDocs(q3)])
                    .then(([customerEvents, allEvents, leaveEvents]) => {
                        const events = [];

                        customerEvents.forEach(doc => {
                            const data = doc.data();
                            events.push({
                                title: data.title,
                                start: data.start,
                                end: data.end,
                                backgroundColor: data.assignedTo === 'all' ? 'green' : 'pink',
                                textColor: 'black',
                                description: data.description
                            });
                        });

                        allEvents.forEach(doc => {
                            const data = doc.data();
                            events.push({
                                title: data.title,
                                start: data.start,
                                end: data.end,
                                backgroundColor: 'green',
                                textColor: 'black',
                                description: data.description
                            });
                        });

                        leaveEvents.forEach(doc => {
                            const data = doc.data();
                            events.push({
                                title: 'Vrije dag',
                                start: data.start,
                                end: data.end,
                                backgroundColor: 'blue',
                                textColor: 'black',
                                description: data.description
                            });
                        });

                        successCallback(events);
                    })
                    .catch(error => {
                        console.error('Fout bij het ophalen van events:', error);
                        failureCallback(error);
                    });
            },
            eventDidMount: function(info) {
                if (info.event.extendedProps.description) {
                    tippy(info.el, {
                        content: info.event.extendedProps.description,
                    });
                }
            }
        });
        calendar.render();
    }

    // Functie om urenregistraties te downloaden
    document.getElementById('download-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const user = auth.currentUser;
        if (user) {
            const employeeId = document.getElementById('download-employee-select').value;
            const startDate = new Date(document.getElementById('download-start-day').value);
            const endDate = new Date(document.getElementById('download-end-day').value);
            const format = document.getElementById('download-format').value;

            const q = query(collection(db, 'hours'), where('userId', '==', employeeId), where('day', '>=', startDate), where('day', '<=', endDate));
            getDocs(q).then(querySnapshot => {
                const hoursData = [];
                querySnapshot.forEach(doc => {
                    const hours = doc.data();
                    hoursData.push({
                        Datum: hours.day.toDate().toISOString().split('T')[0],
                        'Begin Tijd': hours.startTime,
                        'Pauze in Minuten': hours.breakTime,
                        'Eind Tijd': hours.endTime,
                        'Totaal Uur': hours.hoursWorked,
                        Notities: hours.notes || 'Geen notitie'
                    });
                });

                if (hoursData.length > 0) {
                    if (format === 'pdf') {
                        downloadAsPDF(hoursData);
                    } else if (format === 'excel') {
                        downloadAsExcel(hoursData);
                    } else if (format === 'word') {
                        downloadAsWord(hoursData);
                    }
                } else {
                    alert('Geen uren gevonden in de opgegeven periode.');
                }
            }).catch((error) => {
                console.error('Fout bij het ophalen van uren:', error);
            });
        } else {
            alert('Je moet ingelogd zijn om uren te downloaden.');
        }
    });

    // Functie om uren te downloaden als PDF
    function downloadAsPDF(hoursData) {
        // Implementatie voor PDF download
    }

    // Functie om uren te downloaden als Excel
    function downloadAsExcel(hoursData) {
        // Implementatie voor Excel download
    }

    // Functie om uren te downloaden als Word
    function downloadAsWord(hoursData) {
        // Implementatie voor Word download
    }
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: white;
            margin: 0;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
        }
        .dashboard-box {
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        .dashboard-box h2, .dashboard-box h3 {
            margin-top: 0;
            color: #d4d4d4;
        }
        .dashboard-box p, .dashboard-box label {
            color: #d4d4d4;
        }
        .dashboard-box input, .dashboard-box button, .dashboard-box select {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 5px;
        }
        .dashboard-box button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        .dashboard-box button:hover {
            background-color: #45a049;
        }
        .dashboard-box input[type="number"], .dashboard-box input[type="date"], .dashboard-box input[type="time"] {
            background-color: #3a3a3a;
            color: white;
        }
        .dashboard-box meter {
            width: 100%;
        }
        .dashboard-box .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .dashboard-box .calendar-container {
            max-width: 100%;
        }

        /* Tabel opmaak */
        .hours-table {
            width: 100%;
            border-collapse: collapse;
        }
        .hours-table th, .hours-table td {
            border: 1px solid #3a3a3a;
            padding: 8px;
            text-align: left;
        }
        .hours-table th {
            background-color: #4CAF50;
            color: white;
        }
        .hours-item {
            display: table-row;
        }
        .hours-item span {
            display: table-cell;
            padding: 8px;
            border: 1px solid #3a3a3a;
        }
        .notes-popup {
            display: none;
            position: absolute;
            background-color: #4c4c4c; /* Iets lichtere achtergrondkleur */
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            z-index: 100;
            max-width: 300px;
            max-height: 200px; /* Maximum height for the popup */
            overflow-y: auto; /* Scroll if the content exceeds the max height */
            left: 50%; /* Adjusted position */
            top: 50%; /* Adjusted position */
            transform: translate(-50%, -50%);
        }
        .notes-popup.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="dashboard-box" id="customer-info-box">
        <h2>Klant Gegevens</h2>
        <p>Naam: <span id="customer-name"></span></p>
        <p>Email: <span id="customer-email"></span></p>
    </div>

    <div class="dashboard-box" id="project-info-box">
        <h2>Projecten</h2>
        <div id="project-list"></div>
    </div>

    <div class="dashboard-box" id="employee-info-box">
        <h2>Werknemers</h2>
        <select id="employee-select">
            <option value="">Selecteer een werknemer</option>
        </select>
        <table class="hours-table">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Begin Tijd</th>
                    <th>Pauze in Minuten</th>
                    <th>Eind Tijd</th>
                    <th>Totaal Uur</th>
                    <th>Notities</th>
                </tr>
            </thead>
            <tbody id="hours-logged">
            </tbody>
        </table>
        <div class="actions">
            <button onclick="previousWeek()">Vorige Week</button>
            <button onclick="nextWeek()">Volgende Week</button>
        </div>
    </div>

    <div class="dashboard-box calendar-container" id="agenda-box">
        <h2>Gezamenlijke Agenda</h2>
        <div id="calendar"></div>
    </div>

    <div class="dashboard-box" id="event-box">
        <h2>Evenement Toevoegen</h2>
        <form id="event-form">
            <div>
                <label for="event-title">Titel:</label>
                <input type="text" id="event-title" required>
            </div>
            <div>
                <label for="event-start-day">Startdag:</label>
                <input type="date" id="event-start-day" required>
            </div>
            <div>
                <label for="event-end-day">Einddag:</label>
                <input type="date" id="event-end-day" required>
            </div>
            <div>
                <label for="event-start-time">Starttijd:</label>
                <input type="time" id="event-start-time">
            </div>
            <div>
                <label for="event-end-time">Eindtijd:</label>
                <input type="time" id="event-end-time">
            </div>
            <div>
                <label for="event-description">Beschrijving:</label>
                <textarea id="event-description" rows="4"></textarea>
            </div>
            <div>
                <label for="event-assigned-to">Toewijzen aan:</label>
                <select id="event-assigned-to">
                    <option value="all">Alle werknemers</option>
                </select>
            </div>
            <button type="submit">Evenement Toevoegen</button>
        </form>
    </div>

    <div class="dashboard-box" id="download-box">
        <h2>Download Geregistreerde Uren</h2>
        <form id="download-form">
            <div>
                <label for="employee-download-select">Werknemer:</label>
                <select id="employee-download-select" required>
                    <option value="">Selecteer een werknemer</option>
                </select>
            </div>
            <div>
                <label for="start-date">Vanaf datum:</label>
                <input type="date" id="start-date" required>
            </div>
            <div>
                <label for="end-date">Tot datum:</label>
                <input type="date" id="end-date" required>
            </div>
            <div>
                <label for="download-format">Formaat:</label>
                <select id="download-format" required>
                    <option value="pdf">PDF</option>
                    <option value="excel">Excel</option>
                    <option value="word">Word</option>
                </select>
            </div>
            <button type="submit">Download</button>
        </form>
    </div>

    <div id="notes-popup" class="notes-popup"></div>
</body>
</html>
